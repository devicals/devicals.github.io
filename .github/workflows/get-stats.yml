name: Update Repository Stats
on:
  schedule:
    - cron: '0 0 * * *'
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install pyyaml requests

      - name: Fetch and Save Stats
        run: |
          python - <<EOF
          import requests
          import yaml
          import os

          repo_url = "https://api.github.com/repos/devicals/devicals.github.io"
          lang_url = f"{repo_url}/languages"

          # Fetch Repo Data
          repo_data = requests.get(repo_url).json()
          # Fetch Language Data
          lang_data = requests.get(lang_url).json()

          stats = {
              "stars": repo_data.get("stargazers_count", 0),
              "forks": repo_data.get("forks_count", 0),
              "watchers": repo_data.get("subscribers_count", 0),
              "size": repo_data.get("size", 0),
              "languages": []
          }

          total_bytes = sum(lang_data.values())
          if total_bytes > 0:
              for lang, bytes in lang_data.items():
                  percentage = round((bytes / total_bytes) * 100, 1)
                  stats["languages"].append({"name": lang, "percent": percentage})

          # Ensure directory exists
          os.makedirs('storage/internal', exist_ok=True)

          with open('storage/internal/stats.yaml', 'w') as f:
              yaml.dump(stats, f, default_flow_style=False)
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add storage/internal/stats.yaml
          git commit -m "Update repository statistics" || exit 0
          git push --force