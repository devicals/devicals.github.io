<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery - Error Dev</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="storage/internal/page-styles.css">
    <script src="storage/internal/embed-detect.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        .gallery-grid {
            display: flex;
            flex-direction: column;
            gap: 32px;
            padding-bottom: 100px;
        }

        .gallery-card {
            background: #181818 !important;
            border: 1px solid #2d2e2e !important;
            border-radius: 0;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }

        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #181818 !important;
            border-bottom: 1px solid #2d2e2e !important;
        }

        .gallery-type-label {
            color: #7e7e7e !important;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .download-btn {
            display: inline-block !important;
            text-decoration: none !important;
            background: #181818 !important;
            border: 1px solid #2d2e2e !important;
            color: #7e7e7e !important;
            padding: 4px 10px !important;
            font-size: 9px !important;
            font-weight: 600 !important;
            text-transform: uppercase !important;
            transition: all 0.2s ease !important;
        }

        .download-btn:hover {
            background: #1b1e1d !important;
            border-color: #dbd7ca !important;
            color: #dbd7ca !important;
        }

        .gallery-media-container {
            background: #181818 !important;
        }

        .gallery-media-container img, 
        .gallery-media-container video {
            max-width: 100%;
            height: auto;
            display: block;
        }

        .gallery-info {
            padding: 12px 16px;
            border-top: 1px solid #2d2e2e !important;
        }

        .gallery-item-title {
            font-size: 14px;
            font-weight: 700;
            color: hsl(var(--accent));
            margin-bottom: 4px;
        }

        .gallery-item-desc {
            font-size: 12px;
            color: hsl(var(--foreground));
            opacity: 0.8;
            margin: 0;
        }

        /* Audio Player Styles */
        .audio-ui {
            width: 100%;
            background: #121212;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 200px;
            justify-content: center;
        }

        .audio-ui audio {
            display: none;
        }

        .audio-controls-row {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .audio-btn {
            background: #181818;
            border: 1px solid #2d2e2e;
            color: #7e7e7e;
            padding: 0;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 20px;
            font-weight: 600;
            transition: all 0.2s;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .audio-btn:hover {
            border-color: #dbd7ca;
            color: #dbd7ca;
            background: #1b1e1d;
        }

        .audio-btn.active {
            border-color: #dbd7ca;
            color: #dbd7ca;
        }

        .audio-btn-small {
            width: 50px;
            height: 50px;
            font-size: 14px;
        }

        .audio-progress {
            flex-grow: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: #2d2e2e;
            outline: none;
            cursor: pointer;
        }

        .audio-progress::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: #dbd7ca;
            cursor: pointer;
            border-radius: 50%;
        }

        .audio-progress::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: #dbd7ca;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }

        .audio-time-display {
            color: #7e7e7e;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
            letter-spacing: 0.5px;
            margin: 0;
        }

        /* Filter Styles - Collapsible from right */
        .filter-box {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #181818;
            border: 1px solid #2d2e2e;
            border-right: none;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-start;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .filter-box.collapsed {
            transform: translate(100%, -50%);
        }

        .filter-toggle {
            position: absolute;
            left: -30px;
            top: 50%;
            transform: translateY(-50%);
            background: #181818;
            border: 1px solid #2d2e2e;
            border-right: none;
            color: #7e7e7e;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.2s;
            font-family: monospace;
        }

        .filter-toggle:hover {
            background: #1b1e1d;
            color: #dbd7ca;
        }

        .filter-label {
            color: #7e7e7e;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .filter-box label {
            color: #dbd7ca;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: 'JetBrains Mono', monospace;
        }

        .filter-box input[type="checkbox"] {
            cursor: pointer;
            accent-color: #dbd7ca;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <h1 class="page-title" id="gallery-title">Gallery</h1>
        
        <div class="filter-box" id="filter-box">
            <div class="filter-toggle" id="filter-toggle" onclick="toggleFilter()">&lt;</div>
            <span class="filter-label">GALLERY FILTER</span>
            <label>
                <input type="checkbox" id="filter-img" checked onchange="applyFilters()"> IMAGES
            </label>
            <label>
                <input type="checkbox" id="filter-video" checked onchange="applyFilters()"> VIDEOS
            </label>
            <label>
                <input type="checkbox" id="filter-audio" checked onchange="applyFilters()"> AUDIO
            </label>
        </div>
        
        <div class="gallery-grid" id="gallery-grid"></div>
    </div>
    
    <script>
        let galleryData = [];
        let imgExtensions = [];
        let videoExtensions = [];
        let audioExtensions = [];
        let galleryType = 'gallery';

        async function parseExtensionList(path) {
            try {
                const resp = await fetch(path);
                if (!resp.ok) {
                    console.error('Failed to fetch extension list:', path);
                    return [];
                }
                const text = await resp.text();
                console.log('Extension list content:', path, text.substring(0, 200));
                
                const regex = /\(([\s\S]*?)\)/;
                const match = text.match(regex);
                if (!match) {
                    console.error('No match found in extension list:', path);
                    return [];
                }
                
                // Split by comma or newline
                const extensions = match[1]
                    .split(/[,\n]/)
                    .map(s => s.trim().replace(/["']/g, ''))
                    .filter(s => s.length > 0);
                
                console.log('Parsed extensions from', path, ':', extensions.length, 'extensions');
                return extensions;
            } catch (e) {
                console.error('Failed to parse extension list:', path, e);
                return [];
            }
        }

        function getItemType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (imgExtensions.includes(ext)) return 'IMAGE';
            if (videoExtensions.includes(ext)) return 'VIDEO';
            if (audioExtensions.includes(ext)) return 'AUDIO';
            return 'UNKNOWN';
        }

        async function loadGallery() {
            const params = new URLSearchParams(window.location.search);
            const filePath = params.get('file');
            galleryType = params.get('type') || 'gallery';

            if (!filePath) return;

            // Load extension lists
            [imgExtensions, videoExtensions, audioExtensions] = await Promise.all([
                parseExtensionList('storage/internal/ext/image.list'),
                parseExtensionList('storage/internal/ext/video.list'),
                parseExtensionList('storage/internal/ext/music.list')
            ]);

            console.log('=== EXTENSION LOADING ===');
            console.log('Image extensions:', imgExtensions.length, imgExtensions.slice(0, 10));
            console.log('Video extensions:', videoExtensions.length, videoExtensions.slice(0, 10));
            console.log('Audio extensions:', audioExtensions.length, audioExtensions.slice(0, 10));
            console.log('========================');

            // Load YAML data
            const response = await fetch('storage/data/' + filePath);
            const text = await response.text();
            const data = jsyaml.load(text);
            galleryData = data.items || [];

            console.log('Gallery items:', galleryData.length);

            renderGallery();

            // Handle ID jumping
            const jumpId = params.get('id');
            if (jumpId) {
                setTimeout(() => {
                    const el = document.getElementById(`item-${jumpId}`);
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 500);
            }
        }

        function renderGallery() {
            const container = document.getElementById('gallery-grid');
            container.innerHTML = '';
            
            const showImgs = document.getElementById('filter-img').checked;
            const showVideos = document.getElementById('filter-video').checked;
            const showAudio = document.getElementById('filter-audio').checked;

            console.log('Filter states - Images:', showImgs, 'Videos:', showVideos, 'Audio:', showAudio);

            let renderedCount = 0;
            let imgCount = 0, vidCount = 0, audCount = 0;

            galleryData.forEach((item, index) => {
                const id = item.id || index;
                const type = getItemType(item.path);
                const ext = item.path.split('.').pop().toLowerCase();

                if (type === 'IMAGE') imgCount++;
                if (type === 'VIDEO') vidCount++;
                if (type === 'AUDIO') audCount++;

                if (index < 3) {
                    console.log(`Item ${index}:`, item.path, '| Ext:', ext, '| Type:', type);
                }

                // Filter based on page type
                if (galleryType === 'gallery.img' && type !== 'IMAGE') return;
                if (galleryType === 'gallery.video' && type !== 'VIDEO') return;
                if (galleryType === 'gallery.audio' && type !== 'AUDIO') return;
                
                // Filter based on checkboxes (for 'gallery' type)
                if (galleryType === 'gallery') {
                    if (type === 'IMAGE' && !showImgs) return;
                    if (type === 'VIDEO' && !showVideos) return;
                    if (type === 'AUDIO' && !showAudio) return;
                }

                renderedCount++;

                const card = document.createElement('div');
                card.className = 'gallery-card';
                card.id = `item-${id}`;
                
                let mediaHtml = '';
                if (type === 'IMAGE') {
                    mediaHtml = `<img src="storage/data/${item.path}" loading="lazy" alt="${item.title || 'Image'}">`;
                } else if (type === 'VIDEO') {
                    mediaHtml = `<video src="storage/data/${item.path}" controls preload="metadata"></video>`;
                } else if (type === 'AUDIO') {
                    mediaHtml = `
                        <div class="audio-ui">
                            <audio id="aud-${index}" src="storage/data/${item.path}" preload="metadata"></audio>
                            <div class="audio-controls-row">
                                <button class="audio-btn" id="play-btn-${index}">▶</button>
                                <input type="range" id="seek-${index}" class="audio-progress" value="0" step="0.1" max="100">
                                <button class="audio-btn audio-btn-small" id="repeat-btn-${index}" title="Repeat Once">1</button>
                                <button class="audio-btn audio-btn-small" id="loop-btn-${index}" title="Loop">∞</button>
                            </div>
                            <div class="audio-time-display" id="time-${index}">00:00 / 00:00</div>
                        </div>`;
                }

                card.innerHTML = `
                    <div class="gallery-header">
                        <span class="gallery-type-label">${type}</span>
                        <a href="storage/data/${item.path}" download class="download-btn">Download</a>
                    </div>
                    <div class="gallery-media-container">
                        ${mediaHtml}
                    </div>
                    ${item.title ? `
                    <div class="gallery-info">
                        <div class="gallery-item-title">${item.title}</div>
                        ${item.description ? `<div class="gallery-item-desc">${item.description}</div>` : ''}
                    </div>` : ''}
                `;
                container.appendChild(card);

                // Setup audio player functionality
                if (type === 'AUDIO') {
                    setTimeout(() => {
                        const aud = document.getElementById(`aud-${index}`);
                        const playBtn = document.getElementById(`play-btn-${index}`);
                        const seek = document.getElementById(`seek-${index}`);
                        const timeDisplay = document.getElementById(`time-${index}`);
                        const repeatBtn = document.getElementById(`repeat-btn-${index}`);
                        const loopBtn = document.getElementById(`loop-btn-${index}`);
                        
                        let repeatOnce = false;
                        
                        const formatTime = (seconds) => {
                            if (isNaN(seconds)) return '00:00';
                            const mins = Math.floor(seconds / 60);
                            const secs = Math.floor(seconds % 60);
                            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                        };
                        
                        if (aud && playBtn && seek && timeDisplay && repeatBtn && loopBtn) {
                            aud.addEventListener('loadedmetadata', () => {
                                seek.max = aud.duration;
                                timeDisplay.textContent = `00:00 / ${formatTime(aud.duration)}`;
                            });
                            
                            playBtn.addEventListener('click', () => {
                                if (aud.paused) {
                                    aud.play();
                                    playBtn.innerHTML = '⏸';
                                } else {
                                    aud.pause();
                                    playBtn.innerHTML = '▶';
                                }
                            });
                            
                            // Repeat once button
                            repeatBtn.addEventListener('click', () => {
                                repeatOnce = !repeatOnce;
                                if (repeatOnce) {
                                    repeatBtn.classList.add('active');
                                    aud.loop = false;
                                    loopBtn.classList.remove('active');
                                } else {
                                    repeatBtn.classList.remove('active');
                                }
                            });
                            
                            // Loop button
                            loopBtn.addEventListener('click', () => {
                                aud.loop = !aud.loop;
                                if (aud.loop) {
                                    loopBtn.classList.add('active');
                                    repeatOnce = false;
                                    repeatBtn.classList.remove('active');
                                } else {
                                    loopBtn.classList.remove('active');
                                }
                            });
                            
                            aud.addEventListener('timeupdate', () => {
                                seek.value = aud.currentTime;
                                timeDisplay.textContent = `${formatTime(aud.currentTime)} / ${formatTime(aud.duration)}`;
                            });
                            
                            seek.addEventListener('input', () => {
                                aud.currentTime = parseFloat(seek.value);
                            });
                            
                            aud.addEventListener('ended', () => {
                                if (repeatOnce) {
                                    aud.currentTime = 0;
                                    aud.play();
                                    repeatOnce = false;
                                    repeatBtn.classList.remove('active');
                                } else {
                                    playBtn.innerHTML = '▶';
                                }
                            });
                        }
                    }, 0);
                }
            });

            console.log('=== RENDER SUMMARY ===');
            console.log('Total items:', galleryData.length);
            console.log('Image items:', imgCount, '| Video items:', vidCount, '| Audio items:', audCount);
            console.log('Rendered:', renderedCount, 'items');
            console.log('=====================');
        }

        function applyFilters() {
            renderGallery();
        }

        function toggleFilter() {
            const filterBox = document.getElementById('filter-box');
            const toggle = document.getElementById('filter-toggle');
            filterBox.classList.toggle('collapsed');
            
            if (filterBox.classList.contains('collapsed')) {
                toggle.innerHTML = '&gt;';
            } else {
                toggle.innerHTML = '&lt;';
            }
        }

        document.addEventListener('DOMContentLoaded', loadGallery);
    </script>
</body>
</html>