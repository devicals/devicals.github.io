<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery - Error Dev</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/storage/internal/styles/page-styles.css">
    <script src="/storage/internal/scripts/embed-detect.js"></script>
    <script src="/storage/internal/scripts/theme-manager.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <style>
        .gallery-grid {
            display: flex;
            flex-direction: column;
            gap: 32px;
            padding-bottom: 100px;
        }

        .gallery-card {
            background: hsl(var(--card)) !important;
            border: 1px solid hsl(var(--border)) !important;
            border-radius: 0;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }
        
        .gallery-card.body-only {
            padding: 24px;
            border-style: dashed !important;
            color: hsl(var(--foreground));
            font-size: 14px;
            line-height: 1.6;
        }
        
        .gallery-card.body-only p { margin-bottom: 1em; }
        .gallery-card.body-only p:last-child { margin-bottom: 0; }
        .gallery-card.body-only code { background: hsl(var(--secondary)); padding: 2px 4px; border-radius: 3px; }

        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: hsl(var(--card)) !important;
            border-bottom: 1px solid hsl(var(--border)) !important;
        }

        .header-left {
            display: flex;
            gap: 10px;
            align-items: center;
            cursor: pointer;
        }

        .gallery-id-label {
            color: hsl(var(--accent));
            font-size: 10px;
            font-weight: 800;
        }

        .gallery-type-label {
            color: hsl(var(--muted-foreground)) !important;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .download-btn {
            display: inline-block !important;
            text-decoration: none !important;
            background: hsl(var(--card)) !important;
            border: 1px solid hsl(var(--border)) !important;
            color: hsl(var(--foreground)) !important;
            padding: 4px 10px !important;
            font-size: 9px !important;
            font-weight: 600 !important;
            text-transform: uppercase !important;
            transition: all 0.2s ease !important;
        }

        .download-btn:hover {
            background: hsl(var(--accent)) !important;
            border-color: hsl(var(--accent)) !important;
            color: hsl(var(--accent-foreground)) !important;
        }

        .gallery-media-container {
            background: hsl(var(--card)) !important;
        }

        .gallery-media-container img, 
        .gallery-media-container video {
            max-width: 100%;
            height: auto;
            display: block;
        }

        .gallery-info {
            padding: 12px 16px;
            border-top: 1px solid hsl(var(--border)) !important;
            background: hsl(var(--card)) !important;
        }

        .gallery-item-title {
            font-size: 14px;
            font-weight: 700;
            color: hsl(var(--accent));
            margin-bottom: 4px;
            cursor: pointer;
        }

        .gallery-item-desc {
            font-size: 12px;
            color: hsl(var(--foreground));
            opacity: 0.8;
            margin: 0;
        }

        .audio-ui {
            width: 100%;
            background: hsl(var(--secondary)) !important;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 200px;
            justify-content: center;
            position: relative;
        }

        .audio-ui audio { display: none; }

        .audio-controls-row {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .audio-btn {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            color: hsl(var(--foreground));
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 20px;
            font-weight: 600;
            transition: all 0.2s;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .audio-btn:hover:not(:disabled) { border-color: hsl(var(--accent)); color: hsl(var(--accent)); background: hsl(var(--muted)); }
        .audio-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .audio-btn.active { border-color: hsl(var(--accent)); color: hsl(var(--accent)); }
        .audio-btn-small { width: 50px; height: 50px; font-size: 14px; }

        .audio-progress {
            flex-grow: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: hsl(var(--border));
            outline: none;
            cursor: pointer;
        }
        
        .audio-progress:disabled { cursor: not-allowed; opacity: 0.5; }

        .audio-progress::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: hsl(var(--foreground));
            border-radius: 50%;
        }
        
        .audio-progress:disabled::-webkit-slider-thumb { background: hsl(var(--muted-foreground)); }

        .audio-time-display {
            color: hsl(var(--muted-foreground));
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
            letter-spacing: 0.5px;
            margin: 0;
        }

        .audio-error-msg {
            color: hsl(var(--foreground));
            font-size: 12px;
            opacity: 0.8;
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
            margin-bottom: 8px;
            display: none;
        }

        .filter-box {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: hsl(var(--card)) !important;
            border: 1px solid hsl(var(--border));
            border-right: none;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .filter-box.collapsed { transform: translate(100%, -50%); }

        .filter-toggle {
            position: absolute;
            left: -30px;
            top: 50%;
            transform: translateY(-50%);
            background: hsl(var(--card)) !important;
            border: 1px solid hsl(var(--border));
            border-right: none;
            color: hsl(var(--foreground));
            padding: 8px 10px;
            cursor: pointer;
            font-family: monospace;
        }

        .filter-label {
            color: hsl(var(--muted-foreground));
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .filter-box label {
            color: hsl(var(--foreground));
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'JetBrains Mono', monospace;
        }

        .jump-container {
            margin-top: 8px;
            padding-top: 12px;
            border-top: 1px solid hsl(var(--border));
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .jump-input {
            background: hsl(var(--background)) !important;
            border: 1px solid hsl(var(--border));
            color: hsl(var(--foreground));
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            padding: 4px 8px;
            width: 100px;
        }

        .jump-btn {
            background: hsl(var(--secondary));
            color: hsl(var(--foreground));
            border: 1px solid hsl(var(--border));
            padding: 4px;
            font-size: 10px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
        }

        .jump-btn:hover { background: hsl(var(--accent)); color: hsl(var(--accent-foreground)); border-color: hsl(var(--accent)); }

        #copy-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: hsl(var(--accent));
            color: hsl(var(--accent-foreground));
            padding: 8px 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: bold;
            display: none;
            z-index: 2000;
        }
    </style>
</head>
<body>
    <div id="copy-toast">LINK COPIED TO CLIPBOARD</div>
    <div class="page-container">
        <h1 class="page-title" id="gallery-title">Gallery</h1>
        
        <div class="filter-box" id="filter-box">
            <div class="filter-toggle" id="filter-toggle" onclick="toggleFilter()">&lt;</div>
            <span class="filter-label">GALLERY FILTER</span>
            
            <label id="label-img" style="display:none">
                <input type="checkbox" id="filter-img" checked onchange="applyFilters()"> IMAGES
            </label>
            <label id="label-video" style="display:none">
                <input type="checkbox" id="filter-video" checked onchange="applyFilters()"> VIDEOS
            </label>
            <label id="label-audio" style="display:none">
                <input type="checkbox" id="filter-audio" checked onchange="applyFilters()"> AUDIO
            </label>

            <div class="jump-container">
                <span class="filter-label">JUMP TO ID</span>
                <input type="number" id="jump-id-input" class="jump-input" placeholder="ID #">
                <button class="jump-btn" onclick="executeJump()">Jump</button>
            </div>
        </div>
        
        <div class="gallery-grid" id="gallery-grid"></div>
    </div>
    
    <script>
        let galleryData = [];
        let imgExtensions = [];
        let videoExtensions = [];
        let audioExtensions = [];
        let galleryType = 'gallery';
        let currentPageId = '';
        let yamlFilePath = '';

        async function parseExtensionList(path) {
            try {
                const resp = await fetch(path);
                if (!resp.ok) return [];
                const text = await resp.text();
                const regex = /\(([\s\S]*?)\)/;
                const match = text.match(regex);
                if (!match) return [];
                return match[1].split(/[,\n]/).map(s => s.trim().replace(/["']/g, '')).filter(s => s.length > 0);
            } catch (e) { return []; }
        }

        function getItemType(filename) {
            if (!filename) return 'NONE';
            const ext = filename.split('.').pop().toLowerCase();
            if (imgExtensions.includes(ext)) return 'IMAGE';
            if (videoExtensions.includes(ext)) return 'VIDEO';
            if (audioExtensions.includes(ext)) return 'AUDIO';
            return 'UNKNOWN';
        }

        async function loadGallery() {
            const params = new URLSearchParams(window.location.search);
            yamlFilePath = params.get('file');
            galleryType = params.get('type') || 'gallery';
            const parentHash = window.parent.location.hash.substring(1);
            const parentParams = new URLSearchParams(parentHash);
            currentPageId = parentParams.get('page') || 'home';

            if (!yamlFilePath) return;

            [imgExtensions, videoExtensions, audioExtensions] = await Promise.all([
                parseExtensionList('/storage/internal/ext/image.list'),
                parseExtensionList('/storage/internal/ext/video.list'),
                parseExtensionList('/storage/internal/ext/music.list')
            ]);

            const response = await fetch(yamlFilePath);
            const text = await response.text();
            const data = jsyaml.load(text);
            galleryData = data.items || [];

            renderGallery();
            const jumpId = parentParams.get('id');
            if (jumpId) {
                setTimeout(() => {
                    const el = document.getElementById(`item-${jumpId}`);
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 800);
            }
        }

        function copyLink(id) {
            const newHash = `page=${currentPageId}&id=${id}`;
            const baseUrl = window.parent.location.origin + window.parent.location.pathname;
            const fullUrl = `${baseUrl}#${newHash}`;
            window.parent.history.replaceState(null, null, `#${newHash}`);
            navigator.clipboard.writeText(fullUrl).then(() => {
                const toast = document.getElementById('copy-toast');
                toast.textContent = `LINK COPIED & URL UPDATED [#${id}]`;
                toast.style.display = 'block';
                setTimeout(() => { toast.style.display = 'none'; }, 2000);
            });
            document.querySelectorAll('.gallery-card').forEach(card => card.style.borderColor = '#2d2e2e');
            const activeCard = document.getElementById(`item-${id}`);
            if (activeCard) activeCard.style.borderColor = 'hsl(var(--accent))';
        }

        function executeJump() {
            const id = document.getElementById('jump-id-input').value;
            const el = document.getElementById(`item-${id}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.style.outline = '2px solid hsl(var(--accent))';
                setTimeout(() => el.style.outline = 'none', 2000);
            }
        }

        function renderGallery() {
            const container = document.getElementById('gallery-grid');
            container.innerHTML = '';
            
            const showImgs = document.getElementById('filter-img').checked;
            const showVideos = document.getElementById('filter-video').checked;
            const showAudio = document.getElementById('filter-audio').checked;

            let typesFound = { IMAGE: false, VIDEO: false, AUDIO: false };
            const headerItem = galleryData.find(i => i.id === 0);
            if (headerItem) {
                const headCard = document.createElement('div');
                headCard.className = 'gallery-card body-only';
                headCard.id = `item-0`;
                headCard.innerHTML = headerItem.body ? marked.parse(headerItem.body) : '';
                container.appendChild(headCard);
            }

            const yamlBaseDir = yamlFilePath.substring(0, yamlFilePath.lastIndexOf('/') + 1);

            galleryData.forEach((item, index) => {
                if (item.id === 0) return;

                let resolvedPath = item.path;
                if (!item.path.startsWith('/')) {
                    resolvedPath = yamlBaseDir + item.path;
                }
                
                const id = item.id || index;
                const type = getItemType(item.path);

                if (type !== 'UNKNOWN') typesFound[type] = true;
                if (galleryType === 'gallery.img' && type !== 'IMAGE') return;
                if (galleryType === 'gallery.video' && type !== 'VIDEO') return;
                if (galleryType === 'gallery.audio' && type !== 'AUDIO') return;
                
                if (galleryType === 'gallery') {
                    if (type === 'IMAGE' && !showImgs) return;
                    if (type === 'VIDEO' && !showVideos) return;
                    if (type === 'AUDIO' && !showAudio) return;
                }

                const card = document.createElement('div');
                card.className = 'gallery-card';
                card.id = `item-${id}`;
                
                let mediaHtml = '';
                if (type === 'IMAGE') {
                    mediaHtml = `<img src="${resolvedPath}" loading="lazy">`;
                } else if (type === 'VIDEO') {
                    mediaHtml = `<video src="${resolvedPath}" controls preload="metadata"></video>`;
                } else if (type === 'AUDIO') {
                    mediaHtml = `
                        <div class="audio-ui">
                            <div class="audio-error-msg" id="error-${index}"><strong>Cannot find specified audio file.</strong></div>
                            <audio id="aud-${index}" src="${resolvedPath}" preload="metadata"></audio>
                            <div class="audio-controls-row">
                                <button class="audio-btn" id="play-btn-${index}">▶</button>
                                <input type="range" id="seek-${index}" class="audio-progress" value="0" step="0.1" max="100">
                                <button class="audio-btn audio-btn-small" id="repeat-btn-${index}" title="Repeat Once">1</button>
                                <button class="audio-btn audio-btn-small" id="loop-btn-${index}" title="Loop">∞</button>
                            </div>
                            <div class="audio-time-display" id="time-${index}">00:00 / 00:00</div>
                        </div>`;
                }

                card.innerHTML = `
                    <div class="gallery-header">
                        <div class="header-left" onclick="copyLink('${id}')" title="Click to copy link">
                            <span class="gallery-id-label">#${id}</span>
                            <span class="gallery-type-label">${type}</span>
                        </div>
                        <a href="${resolvedPath}" download class="download-btn">Download</a>
                    </div>
                    <div class="gallery-media-container">
                        ${mediaHtml}
                    </div>
                    ${item.title ? `
                    <div class="gallery-info">
                        <div class="gallery-item-title" onclick="copyLink('${id}')">${item.title}</div>
                        ${item.description ? `<div class="gallery-item-desc">${item.description}</div>` : ''}
                    </div>` : ''}
                `;
                container.appendChild(card);

                if (type === 'AUDIO') setupAudioPlayer(index);
            });
            document.getElementById('label-img').style.display = typesFound.IMAGE ? 'flex' : 'none';
            document.getElementById('label-video').style.display = typesFound.VIDEO ? 'flex' : 'none';
            document.getElementById('label-audio').style.display = typesFound.AUDIO ? 'flex' : 'none';
        }

        function setupAudioPlayer(index) {
            setTimeout(() => {
                const aud = document.getElementById(`aud-${index}`);
                const playBtn = document.getElementById(`play-btn-${index}`);
                const seek = document.getElementById(`seek-${index}`);
                const timeDisplay = document.getElementById(`time-${index}`);
                const repeatBtn = document.getElementById(`repeat-btn-${index}`);
                const loopBtn = document.getElementById(`loop-btn-${index}`);
                const errorDisplay = document.getElementById(`error-${index}`);
                let repeatOnce = false;
                
                const formatTime = (s) => isNaN(s) || s === Infinity ? '00:00' : `${Math.floor(s/60).toString().padStart(2,'0')}:${Math.floor(s%60).toString().padStart(2,'0')}`;
                
                if (!aud || !playBtn) return;

                const disablePlayer = () => {
                    playBtn.disabled = true;
                    seek.disabled = true;
                    repeatBtn.disabled = true;
                    loopBtn.disabled = true;
                    errorDisplay.style.display = 'block';
                    timeDisplay.textContent = "00:00 / 00:00";
                };

                aud.addEventListener('error', disablePlayer);

                aud.addEventListener('loadedmetadata', () => {
                    if (aud.duration === 0 || isNaN(aud.duration)) {
                        disablePlayer();
                    } else {
                        seek.max = aud.duration;
                        timeDisplay.textContent = `00:00 / ${formatTime(aud.duration)}`;
                    }
                });
                
                playBtn.addEventListener('click', () => {
                    if (aud.paused) { aud.play(); playBtn.innerHTML = '⏸'; }
                    else { aud.pause(); playBtn.innerHTML = '▶'; }
                });
                
                repeatBtn.addEventListener('click', () => {
                    repeatOnce = !repeatOnce;
                    repeatBtn.classList.toggle('active', repeatOnce);
                    if (repeatOnce) { aud.loop = false; loopBtn.classList.remove('active'); }
                });
                
                loopBtn.addEventListener('click', () => {
                    aud.loop = !aud.loop;
                    loopBtn.classList.toggle('active', aud.loop);
                    if (aud.loop) { repeatOnce = false; repeatBtn.classList.remove('active'); }
                });
                
                aud.addEventListener('timeupdate', () => {
                    seek.value = aud.currentTime;
                    timeDisplay.textContent = `${formatTime(aud.currentTime)} / ${formatTime(aud.duration)}`;
                });
                
                seek.addEventListener('input', () => { aud.currentTime = parseFloat(seek.value); });
                
                aud.addEventListener('ended', () => {
                    if (repeatOnce) {
                        aud.currentTime = 0; aud.play();
                        repeatOnce = false; repeatBtn.classList.remove('active');
                    } else { playBtn.innerHTML = '▶'; }
                });
            }, 0);
        }

        function applyFilters() { renderGallery(); }

        function toggleFilter() {
            const filterBox = document.getElementById('filter-box');
            const toggle = document.getElementById('filter-toggle');
            filterBox.classList.toggle('collapsed');
            toggle.innerHTML = filterBox.classList.contains('collapsed') ? '&gt;' : '&lt;';
        }

        document.addEventListener('DOMContentLoaded', loadGallery);
        document.getElementById('jump-id-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') executeJump();
        });
    </script>
</body>
</html>